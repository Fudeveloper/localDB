/*! localDB - v0.1.1 - 2014-09-01
* localdb.emptystack.net
* Copyright (c) 2014 Eric Wang; Licensed MIT */
define(function(a,b,c){"use strict";var d,e,f,g,h,i,j,k,l,m,n,o,p;m=window.localStorage,e="ldb_",p=function(a){return function(b){return{}.toString.call(b)==="[object "+a.toLowerCase().replace(/\w/,function(a){return a.toUpperCase()})+"]"}},k=function(a,b){return p(b)(a)},i=p("object"),j=p("string"),f=p("array"),g=p("function"),h=p("number"),n=function(a){return null!=a&&j(a)?JSON.parse(a):[]},o=function(a){return null!=a&&f(a)?JSON.stringify(a):"[]"},d=function(a,b){var c,e,f,g;for(g in b){if(f=b[g],null==a[g])return!1;if(i(f))for(c in f)switch(e=f[c],c){case"$gt":if(a[g]<=e)return!1;break;case"$gte":if(a[g]<e)return!1;break;case"$lt":if(a[g]>=e)return!1;break;case"$lte":if(a[g]>e)return!1;break;case"$ne":if(a[g]===e)return!1;break;default:if(!d(a[g],JSON.parse('{"'+c+'": '+JSON.stringify(e)+"}")))return!1}else if(a[g]!==f)return!1}return!0},l=l||function(a,b){m=b,this.db=e+a,null==m.getItem(this.db)&&m.setItem(this.db,"_"),this.length=function(){return this.collections().length}},l.isSupport=function(){return"undefined"!=typeof localStorage&&null!==localStorage?!0:!1},l.prototype.serialize=function(a,b){return m.setItem(""+this.db+"_"+a,o(b))},l.prototype.deserialize=function(a,b){var c;return null==b&&(b={}),c=n(m.getItem(""+this.db+"_"+a))},l.prototype.drop=function(a){var b,c,d,e,f;for(a=null!=a?"_"+a:"",d=function(){var c,d,e;for(e=[],b=c=0,d=m.length;d>=0?d>c:c>d;b=d>=0?++c:--c)0===m.key(b).indexOf(this.db+a)&&e.push(m.key(b));return e}.call(this),e=0,f=d.length;f>e;e++)c=d[e],m.removeItem(c)},l.prototype.collections=function(){var a,b,c,d;if(null!=this.db){for(d=[],a=b=0,c=m.length;c>=0?c>b:b>c;a=c>=0?++b:--b)0===m.key(a).indexOf(""+this.db+"_")&&d.push(m.key(a));return d}return[]},l.prototype.insert=function(a,b){var c;return c=this.deserialize(a),c.push(b),this.serialize(a,c),this},l.prototype.find=function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r;for(null==b&&(b={}),e=null!=b.criteria?b.criteria:{},j=null!=b.projection?b.projection:{},i=null!=b.limit?b.limit:-1,g=[],r=this.deserialize(a,b.sort),n=0,p=r.length;p>n;n++)if(c=r[n],d(c,e)){if(0===i)break;i-=1,g.push(c)}if("{}"===JSON.stringify(j))return g;for(l=[],o=0,q=g.length;q>o;o++){f=g[o],k={};for(h in j)m=j[h],1===m&&(k[h]=f[h]);l.push(k)}return l},l.prototype.findOne=function(a,b){return null==b&&(b={}),b.limit=1,this.find(a,b)},l.prototype.update=function(a,b){var c,e,f,g,h,i,j,k,l;for(null==b&&(b={}),c=b.action,h=null!=b.criteria?b.criteria:{},g=this.deserialize(a),k=0,l=g.length;l>k;k++)if(f=g[k],d(f,h)){e=c.$set;for(i in e)j=e[i],f[i]=j}return this.serialize(a,g)},l.prototype.remove=function(a,b){var c,e;return null==b&&(b={}),e=null!=b.criteria?b.criteria:{},this.serialize(a,function(){var b,f,g,h;for(g=this.deserialize(a),h=[],b=0,f=g.length;f>b;b++)c=g[b],d(c,e)||h.push(c);return h}.call(this))},c.exports=l});