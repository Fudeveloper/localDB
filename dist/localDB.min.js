/*! localDB - v0.1.1 - 2014-09-02
* localdb.emptystack.net
* Copyright (c) 2014 Eric Wang; Licensed MIT */
define(function(a,b,c){"use strict";var d,e,f,g,h,i,j,k,l,m,n,o,p;return g="ldb_",p=function(a){return function(b){return{}.toString.call(b)==="[object "+a.toLowerCase().replace(/\w/,function(a){return a.toUpperCase()})+"]"}},m=function(a,b){return p(b)(a)},k=p("object"),l=p("string"),h=p("array"),i=p("function"),j=p("number"),n=function(a){return null!=a&&l(a)?JSON.parse(a):[]},o=function(a){return null!=a&&h(a)?JSON.stringify(a):"[]"},f=function(a,b){var c,d,e,g;for(g in b){if(e=b[g],null==a[g])return!1;if(k(e))for(c in e)switch(d=e[c],c){case"$gt":if(a[g]<=d)return!1;break;case"$gte":if(a[g]<d)return!1;break;case"$lt":if(a[g]>=d)return!1;break;case"$lte":if(a[g]>d)return!1;break;case"$ne":if(a[g]===d)return!1;break;default:if(!f(a[g],JSON.parse('{"'+c+'": '+JSON.stringify(d)+"}")))return!1}else if(a[g]!==e)return!1}return!0},e=function(a,b){null==b&&(b=localStorage),this.ls=b,this.name=g+a},e.isSupport=function(){return"undefined"!=typeof localStorage&&null!==localStorage?!0:!1},e.prototype.collections=function(){var a,b,c,d;for(d=[],a=b=0,c=this.ls.length;c>=0?c>b:b>c;a=c>=0?++b:--b)0===this.ls.key(a).indexOf(""+this.name+"_")&&d.push(this.ls.key(a));return d},e.prototype.drop=function(a){var b,c,d,e,f;for(a=null!=a?"_"+a:"",d=function(){var c,d,e;for(e=[],b=c=0,d=this.ls.length;d>=0?d>c:c>d;b=d>=0?++c:--c)0===this.ls.key(b).indexOf(this.name+a)&&e.push(this.ls.key(b));return e}.call(this),e=0,f=d.length;f>e;e++)c=d[e],this.ls.removeItem(c)},e.prototype.collection=function(a){return new d(a,this)},d=function(a,b){this.name=""+b.name+"_"+a,this.ls=b.ls,this.deserialize()},d.prototype.deserialize=function(){return this.data=n(this.ls.getItem(this.name))},d.prototype.serialize=function(){return this.ls.setItem(this.name,o(this.data))},d.prototype.drop=function(){return this.ls.removeItem(this.name)},d.prototype.insert=function(a){return this.deserialize(),this.data.push(a),this.serialize()},d.prototype.update=function(a,b){var c,d,e,g,h,i,j,k;for(d=null!=b.criteria?b.criteria:{},this.deserialize(),k=this.data,i=0,j=k.length;j>i;i++)if(e=k[i],f(e,d)){c=a.$set;for(g in c)h=c[g],e[g]=h}return this.serialize()},d.prototype.remove=function(a){var b,c;return null==a&&(a={}),b=null!=a.criteria?a.criteria:{},this.data=function(){var a,d,e,g;for(e=this.data,g=[],a=0,d=e.length;d>a;a++)c=e[a],f(c,b)||g.push(c);return g}.call(this),this.serialize()},d.prototype.find=function(a){var b,c,d,e,g,h,i,j,k,l,m,n,o,p,q;for(null==a&&(a={}),b=null!=a.criteria?a.criteria:{},j=null!=a.projection?a.projection:{},e=null!=a.limit?a.limit:-1,this.deserialize(),console.log(this.data),k=[],q=this.data,m=0,o=q.length;o>m;m++)if(c=q[m],f(c,b)){if(0===e)break;g=e-1,k.push(c)}if("{}"===JSON.stringify(j))return k;for(i=[],n=0,p=k.length;p>n;n++){c=k[n],h={};for(d in j)l=j[d],1===l&&(h[d]=c[d]);i.push(h)}return i},d.prototype.findOne=function(a){return null==a&&(a={}),a.limit=1,this.find(a)},c.exports=e});