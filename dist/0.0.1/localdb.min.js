/*! localDB - v0.0.1 - 2014-12-04
* https://github.com/wh1100717/localDB
* Copyright (c) 2014 Eric Wang; Licensed MIT */

!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("localdb requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(window,noGlobal){var Support=function(){var a,b;return b="lST$*@?",a={},a.localstorage=function(){var a;try{return localStorage.setItem(b,b),localStorage.removeItem(b),!0}catch(c){return a=c,!1}},a.sessionstorage=function(){var a;try{return sessionStorage.setItem(b,b),sessionStorage.removeItem(b),!0}catch(c){return a=c,!1}},a.postmessage=function(){return"undefined"!=typeof postMessage&&null!==postMessage},a.websqldatabase=function(){return"undefined"!=typeof openDatabase&&null!==openDatabase},a.indexedDB=function(){return"undefined"!=typeof indexedDB&&null!==indexedDB||"undefined"!=typeof webkitIndexedDB&&null!==webkitIndexedDB||"undefined"!=typeof mozIndexedDB&&null!==mozIndexedDB||"undefined"!=typeof OIndexedDB&&null!==OIndexedDB||"undefined"!=typeof msIndexedDB&&null!==msIndexedDB},a.applicationcache=function(){return"undefined"!=typeof applicationCache&&null!==applicationCache},a.userdata=function(){return null!=document.documentElement.addBehavior},a}(),BinaryParser=function(){for(var a=[],b=0;64>b;b++)a[b]=Math.pow(2,b);var c={};c.decodeInt=function e(b,c,d,f){var g=new this.Buffer(this.bigEndian||f,b),h=g.readBits(0,c),i=a[c];return d&&h>=i/2?h-i:h},c.encodeInt=function f(b,c,d,e){var f=a[c];(b>=f||-(f/2)>b)&&(b=0),0>b&&(b+=f);for(var g=[];b;g[g.length]=String.fromCharCode(b%256),b=Math.floor(b/256));for(c=-(-c>>3)-g.length;c--;g[g.length]="\x00");return(this.bigEndian||e?g.reverse():g).join("")},c.fromByte=function(a){return this.encodeInt(a,8,!1)},c.fromShort=function(a){return this.encodeInt(a,16,!0)};function d(a,b){this.bigEndian=a||0,this.buffer=[],this.setBuffer(b)}return d.prototype.setBuffer=function g(a){var b,c,d;if(a){for(c=b=a.length,d=this.buffer=new Array(b);c;d[b-c]=a.charCodeAt(--c));this.bigEndian&&d.reverse()}},d.prototype.hasNeededBits=function h(a){return this.buffer.length>=-(-a>>3)},d.prototype.checkBuffer=function i(a){if(!this.hasNeededBits(a))throw new Error("checkBuffer::missing bytes")},d.prototype.readBits=function j(a,b){function c(a,b){for(;b--;a=1073741824==(1073741824&(a%=2147483648))?2*a:2*(a-1073741824)+2147483647+1);return a}if(0>a||0>=b)return 0;this.checkBuffer(a+b);for(var d,e=a%8,f=this.buffer.length-(a>>3)-1,g=this.buffer.length+(-(a+b)>>3),h=f-g,i=(this.buffer[f]>>e&(1<<(h?8-e:b))-1)+(h&&(d=(a+b)%8)?(this.buffer[g++]&(1<<d)-1)<<(h--<<3)-e:0);h;i+=c(this.buffer[g++],(h--<<3)-e));return i},c.Buffer=d,c}(),ObjectID=function(){var a,b,c;return b=function(){var a,b;for(b=[],c=a=0;256>a;c=++a)b.push((15>=c?"0":"")+c.toString(16));return b}(),a=function(){function a(a,b){if(this._bsontype="ObjectID",this.MACHINE_ID=parseInt(16777215*Math.random(),10),null!=a&&12!==a.length&&24!==a.length)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(null==a)this.id=this.generate();else{if(null==a||12!==a.length){if(/^[0-9a-fA-F]{24}$/.test(a))return this.createFromHexString(a);throw new Error("Value passed in is not a valid 24 character hex string")}this.id=a}}return a.prototype.generate=function(){var a,b,c,d,e;return e=parseInt(Date.now()/1e3,10),d=BinaryParser.encodeInt(e,32,!0,!0),b=BinaryParser.encodeInt(this.MACHINE_ID,24,!1),c=BinaryParser.fromShort("undefined"==typeof process?Math.floor(1e5*Math.random()):process.pid),a=BinaryParser.encodeInt(this.get_inc(),24,!1,!0),d+b+c+a},a.prototype.toHexString=function(){var a,d,e;for(a="",c=d=0,e=this.id.length;e>=0?e>d:d>e;c=e>=0?++d:--d)a+=b[this.id.charCodeAt(c)];return a},a.prototype.toString=function(){return this.toHexString()},a.prototype.inspect=function(){return this.toHexString()},a.prototype.getTime=function(){return 1e3*Math.floor(BinaryParser.decodeInt(this.id.substring(0,4),32,!0,!0))},a.prototype.getTimestamp=function(){var a;return a=new Date,a.setTime(this.getTime()),a},a.prototype.get_inc=function(){return a.index=(a.index+1)%16777215},a.prototype.createFromHexString=function(b){var d,e;for(d="",c=e=0;24>e;c=++e)c%2===0&&(d+=BinaryParser.fromByte(parseInt(b.substr(c,2),16)));return new a(d,b)},a}(),a.index=parseInt(16777215*Math.random(),10),a}(),Utils=function(){var Utils,eq,toString,_isType;return Utils={},toString=Object.prototype.toString,eq=function(a,b,c,d){var e,f,g,h,i,j,k,l,m;if(a===b)return 0!==a||1/a===1/b;if(null===a&&void 0===b)return!1;if(void 0===a&&null===b)return!1;if(h=toString.call(a),h!==toString.call(b))return!1;switch(h){case"[object RegExp]":return""+a==""+b;case"[object String]":return""+a==""+b;case"[object Number]":return+a!==+a?+b!==+b:0===+a?1/+a===1/b:+a===+b;case"[object Date]":return+a===+b;case"[object Boolean]":return+a===+b}if(f="[object Array]"===h,!f){if("object"!=typeof a||"object"!=typeof b)return!1;if(e=a.constructor,g=b.constructor,e!==g&&!(Utils.isFunction(e)&&e instanceof e&&Utils.isFunction(g)&&g instanceof g)&&"constructor"in a&&"constructor"in b)return!1}k=c.length;while(k--)if(c[k]===a)return d[k]===b;if(c.push(a),d.push(b),f){if(m=a.length,l=m===b.length)while(m--)if(!(l=eq(a[m],b[m],c,d)))break}else if(j=Utils.keys(a),m=j.length,l=Utils.keys(b).length===m)while(m--)if(i=j[m],!(l=Utils.has(b,i)&&eq(a[i],b[i],c,d)))break;return c.pop(),d.pop(),l},_isType=function(a){return function(b){return toString.call(b).toLowerCase()===("[object "+a+"]").toLowerCase()}},Utils.isType=function(a,b){return _isType(b)(a)},Utils.isObject=_isType("object"),Utils.isString=_isType("string"),Utils.isNumber=_isType("number"),Utils.isArray=_isType("array"),Utils.isFunction=_isType("function"),Utils.isRegex=_isType("regexp"),Utils.keys=function(a){return Utils.isObject(a)?Object.keys?Object.keys(a):void 0:[]},Utils.has=function(a,b){return null!=a&&Object.prototype.hasOwnProperty.call(a,b)},Utils.isEqual=function(a,b){return eq(a,b,[],[])},Utils.createObjectId=function(){return(new ObjectID).inspect()},Utils.stringify=function(a){return null!=a&&Utils.isArray(a)?JSON.stringify(a,function(a,b){return Utils.isRegex(b)||Utils.isFunction(b)?b.toString():b}):"[]"},Utils.parse=function(str){return null!=str&&Utils.isString(str)?JSON.parse(str,function(key,value){var v;try{v=eval(value)}catch(_error){}if(null!=v&&Utils.isRegex(v))return v;try{v=eval("("+value+")")}catch(_error){}return null!=v&&Utils.isFunction(v)?v:value}):[]},Utils.parseParas=function(a){var b,c;return c={},b=null,1===a.length?Utils.isObject(a[0])?c=a[0]:Utils.isFunction(a[0])&&(b=a[0]):2===a.length&&(Utils.isObject(a[0])&&(c=a[0]),Utils.isFunction(a[1])&&(b=a[1])),[c,b]},Utils.getTimestamp=function(a){return new ObjectID(a).getTimestamp()},Utils.getTime=function(a){return new ObjectID(a).getTime()},Utils.toUnicode=function(a){var b,c,d,e;d=[""],c=1;while(c<=a.length)b=a.charCodeAt(c-1),e="00"+b.toString(16),e=e.slice(-4),d.push(e),c+=1;return d.join("\\u")},Utils.fromUnicode=function(a){return unescape(a.replace(/\\/g,"%"))},Utils.getSubValue=function(a,b){var c,d,e,f;if(null==a)return a;for(d=b.split("."),e=0,f=d.length;f>e;e++)if(c=d[e],a=a[c],null==a)return a;return a},Utils.quickSort=function(a,b,c){var d,e,f,g,h,i,j,k;if(!Utils.isString(b))throw new Error("type Error: key");if(a.length<=1)return a;for(g=a.splice(0,1)[0],f=Utils.getSubValue(g,b),e=[],h=[],j=0,k=a.length;k>j;j++)i=a[j],d=Utils.getSubValue(i,b),(null==d||f>d?e:h).push(i);return Utils.quickSort(1===c?e:h,b,c).concat([g],Utils.quickSort(1===c?h:e,b,c))},Utils.sortObj=function(a,b){var c,d,e,f,g,h,i;if(null==b)return a;e=a,g=[];for(c in b)d=b[c],g.unshift({key:c,order:d});for(h=0,i=g.length;i>h;h++)f=g[h],e=Utils.quickSort(e,f.key,f.order);return e},Utils.getIframe=function(a){var b,c,d,e;for(b=document.getElementsByTagName("iframe"),d=0,e=b.length;e>d;d++)if(c=b[d],0===c.src.indexOf(a))return c;return null},Utils.createIframe=function(a){var b;return b=Utils.getIframe(a),null!=b?b:(b=document.createElement("iframe"),b.src=a,b.style.width="1px",b.style.height="1px",b.style.display="none",document.body.appendChild(b),b)},Utils.getDomain=function(a){return a.match(/(https?:\/\/)?([^\/]+)/)[2].split(":")[0]},Utils.getOrigin=function(a){return a.match(/(https?:\/\/)?([^\/]+)/)[0]},Utils}(),Promise=function(){var a={task:void 0,next:null},b=a,c=!1,d=void 0,e=!1;function f(){while(a.next){a=a.next;var b=a.task;a.task=void 0;var d=a.domain;d&&(a.domain=void 0,d.enter());try{b()}catch(g){if(e)throw d&&d.exit(),setTimeout(f,0),d&&d.enter(),g;setTimeout(function(){throw g},0)}d&&d.exit()}c=!1}if("undefined"!=typeof process&&process.nextTick)e=!0,d=function(){process.nextTick(f)};else if("function"==typeof setImmediate)d="undefined"!=typeof window?setImmediate.bind(window,f):function(){setImmediate(f)};else if("undefined"!=typeof MessageChannel){var g=new MessageChannel;g.port1.onmessage=f,d=function(){g.port2.postMessage(0)}}else d=function(){setTimeout(f,0)};function h(a){b=b.next={task:a,domain:e&&process.domain,next:null},c||(c=!0,d())}function i(a){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");var b=null,c=null,d=[],e=this;this.then=function(a,b){return new e.constructor(function(c,d){f(new j(a,b,c,d))})};function f(a){return null===b?void d.push(a):void h(function(){var d=b?a.onFulfilled:a.onRejected;if(null===d)return void(b?a.resolve:a.reject)(c);var e;try{e=d(c)}catch(f){return void a.reject(f)}a.resolve(e)})}function g(a){try{if(a===e)throw new TypeError("A promise cannot be resolved with itself.");if(a&&("object"==typeof a||"function"==typeof a)){var d=a.then;if("function"==typeof d)return void k(d.bind(a),g,i)}b=!0,c=a,l()}catch(f){i(f)}}function i(a){b=!1,c=a,l()}function l(){for(var a=0,b=d.length;b>a;a++)f(d[a]);d=null}k(a,g,i)}function j(a,b,c,d){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.resolve=c,this.reject=d}function k(a,b,c){var d=!1;try{a(function(a){d||(d=!0,b(a))},function(a){d||(d=!0,c(a))})}catch(e){if(d)return;d=!0,c(e)}}i.prototype.done=function(a,b){var c=arguments.length?this.then.apply(this,arguments):this;c.then(null,function(a){h(function(){throw a})})};function l(a){this.then=function(b){return"function"!=typeof b?this:new i(function(c,d){h(function(){try{c(b(a))}catch(e){d(e)}})})}}l.prototype=i.prototype;var m=new l(!0),n=new l(!1),o=new l(null),p=new l(void 0),q=new l(0),r=new l("");return i.resolve=function(a){if(a instanceof i)return a;if(null===a)return o;if(void 0===a)return p;if(a===!0)return m;if(a===!1)return n;if(0===a)return q;if(""===a)return r;if("object"==typeof a||"function"==typeof a)try{var b=a.then;if("function"==typeof b)return new i(b.bind(a))}catch(c){return new i(function(a,b){b(c)})}return new l(a)},i.all=function(a){var b=Array.prototype.slice.call(a);return new i(function(a,c){if(0===b.length)return a([]);var d=b.length;function e(f,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(a){e(f,a)},c)}b[f]=g,0===--d&&a(b)}catch(i){c(i)}}for(var f=0;f<b.length;f++)e(f,b[f])})},i.reject=function(a){return new i(function(b,c){c(a)})},i.race=function(a){return new i(function(b,c){a.forEach(function(a){i.resolve(a).then(b,c)})})},i.prototype["catch"]=function(a){return this.then(null,a)},i.denodeify=function(a,b){return b=b||1/0,function(){var c=this,d=Array.prototype.slice.call(arguments);return new i(function(e,f){while(d.length&&d.length>b)d.pop();d.push(function(a,b){a?f(a):e(b)}),a.apply(c,d)})}},i.nodeify=function(a){return function(){var b=Array.prototype.slice.call(arguments),c="function"==typeof b[b.length-1]?b.pop():null,d=this;try{return a.apply(this,arguments).nodeify(c,d)}catch(e){if(null===c||"undefined"==typeof c)return new i(function(a,b){b(e)});h(function(){c.call(d,e)})}}},i.prototype.nodeify=function(a,b){return"function"!=typeof a?this:void this.then(function(c){h(function(){a.call(b,null,c)})},function(c){h(function(){a.call(b,c)})})},i}(),Where=function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},b,c,d,e,f,g,h,i,j,k,l;return j=["$gt","$gte","$lt","$lte","$ne","$in","$nin","$and","$nor","$or","$not","$exists","$type","$mod","$regex","$all","$elemMatch","$size"],e=function(b){return a.call(j,b)>=0},b=function(a,b){var c,e;for(e in b){if(c=b[e],null==a){if("$exists"===e&&c===!1)continue;return!1}if(-1!==e.indexOf(".")){if(d(a,e,c))continue;return!1}if(!l(a,e,c))return!1;if(!f(a,e,c))return!1}return!0},d=function(a,c,d){var e;return e=c.split(".")[0],b(a[/\d/.test(e)?Number(e):e],new function(){this[c.substr(c.indexOf(".")+1)]=d})},l=function(a,b,d){var f;return e(b)?!0:(f=a[b],Utils.isNumber(d)&&!g(f,d)?!1:Utils.isString(d)&&!k(f,d)?!1:Utils.isRegex(d)&&!i(f,d)?!1:Utils.isArray(d)&&!c(f,d)?!1:Utils.isObject(d)&&!h(f,d)?!1:!0)},f=function(c,d,e){var g,h,i,j,k,l,m,n,o,p,q;switch(d){case"$gt":if(e>=c)return!1;break;case"$gte":if(e>c)return!1;break;case"$lt":if(c>=e)return!1;break;case"$lte":if(c>e)return!1;break;case"$ne":if(c===e)return!1;break;case"$in":if(Utils.isArray(c)){for(i=!0,j=0,n=c.length;n>j;j++)h=c[j],i&&function(){var a,b,c;for(b=0,c=e.length;c>b;b++)if(a=e[b],Utils.isRegex(a)&&a.test(h)||Utils.isEqual(a,h))return!0;return!1}()&&(i=!1);if(i)return!1}else if(!function(){var a,b,d;for(b=0,d=e.length;d>b;b++)if(a=e[b],Utils.isRegex(a)&&a.test(c)||Utils.isEqual(a,c))return!0;return!1}())return!1;break;case"$nin":if(a.call(e,c)>=0)return!1;break;case"$exists":if(e!==(null!=c))return!1;break;case"$type":if(!Utils.isType(c,e))return!1;break;case"$mod":if(c%e[0]!==e[1])return!1;break;case"$regex":if(!new RegExp(e).test(c))return!1;break;case"$and":for(k=0,o=e.length;o>k;k++)if(g=e[k],!b(c,g))return!1;break;case"$nor":for(l=0,p=e.length;p>l;l++)if(g=e[l],b(c,g))return!1;break;case"$or":if(!function(){var a,d;for(a=0,d=e.length;d>a;a++)if(g=e[a],b(c,g))return!0;return!1}())return!1;break;case"$not":if(b(c,e))return!1;break;case"$all":if(!Utils.isArray(c))return!1;for(m=0,q=e.length;q>m;m++)if(g=e[m],!function(){var a,b;for(b=0,a=c.length;a>b;b++)if(h=c[b],Utils.isArray(g)?f(h,d,g):h===g)return!0}())return!1;break;case"$elemMatch":if(!Utils.isArray(c))return!1;if(!function(){var a,d;for(d=0,a=c.length;a>d;d++)if(h=c[d],b(h,e))return!0}())return!1;break;case"$size":if(!Utils.isArray(c))return!1;if(c.length!==e)return!1}return!0},g=function(b,c){return Utils.isNumber(b)&&c===b?!0:Utils.isArray(b)&&a.call(b,c)>=0?!0:!1},k=function(b,c){return Utils.isString(b)&&c===b?!0:Utils.isArray(b)&&a.call(b,c)>=0?!0:!1},i=function(a,b){var c,d,e;if(Utils.isArray(a)){for(d=0,e=a.length;e>d;d++)if(c=a[d],Utils.isRegex(c)){if(Utils.isEqual(c,b))return!0}else if(b.test(c))return!0}else if(Utils.isRegex(a)){if(Utils.isEqual(a,b))return!0}else if(b.test(a))return!0;return!1},c=function(a,b){return Utils.isEqual(a,b)},h=function(a,c){var d,f,g;f=!0;for(g in c)if(d=c[g],e(g)&&(f=!1,!b(a,new function(){this[g]=d})))return!1;return f?Utils.isEqual(a,c):!0},b}(),Projection=function(){var a,b;return a={},a.generate=function(a,c){var d,e,f,g,h;if("{}"===JSON.stringify(c))return a;for(f=[],g=0,h=a.length;h>g;g++)d=a[g],e=b(d,c),Utils.isEqual(e,{})||f.push(e);return f},b=function(a,c){var d,e,f,g,h,i,j,k,l,m,n,o;j={},g=!0;for(h in c)if(m=c[h],"_id"!==h||-1!==m)if(-1!==h.indexOf(".$")){if(h=h.split(".")[0],!Utils.isArray(a[h])||0===a[h].length)continue;j[h]=[a[h][0]]}else{if(0===h.indexOf("$elemMatch")){if(!Utils.isArray(a)||0===a.length)return[];for(i=[],n=0,o=a.length;o>n;n++){f=a[n],d=!0;for(k in m)l=m[k],Utils.isObject(l)||f[k]!==l&&(d=!1);if(d){i.push(f);break}}return Utils.isEqual(i,[])?[]:i}Utils.isObject(m)?(e=b(a[h],m),Utils.isEqual(e,[])||(j[h]=e)):1===m&&(j[h]=a[h])}else g=!1;return g&&!Utils.isEqual(j,{})&&(j._id=a._id),j},a}(),Operation=function(){var a,b;return a={},a.insert=function(a,b,c){var d,e,f;if(Utils.isArray(b))for(e=0,f=b.length;f>e;e++)d=b[e],Utils.isObject(d)&&(null==d._id&&(d._id=Utils.createObjectId()),a.push(d));else Utils.isObject(b)&&(null==b._id&&(b._id=Utils.createObjectId()),a.push(b));return a},a.update=function(a,c,d){var e,f,g,h,i;i=d.where||{},f=null!=d.multi?d.multi:!0,g=null!=d.upsert?d.upsert:!1;for(e in c)h=c[e],a=b.generate(a,e,h,i,f,g);return a},a.remove=function(a,b){var c,d,e,f,g,h,i;for(g=b.where||{},e=null!=b.multi?b.multi:!0,f=[],d=!1,h=0,i=a.length;i>h;h++)c=a[h],d?f.push(c):Where(c,g)?e||(d=!0):f.push(c);return f},a.find=function(a,b){var c,d,e,f,g,h,i;for(g=b.where||{},e=b.projection||{},d=b.limit||-1,f=[],h=0,i=a.length;i>h;h++)if(c=a[h],Where(c,g)){if(0===d)break;d-=1,f.push(c)}return f=Utils.sortObj(f,b.sort),Projection.generate(f,e)},b={isKeyReserved:function(a){return"$inc"===a||"$set"===a||"$mul"===a||"$rename"===a||"$unset"===a||"$max"===a||"$min"===a},generate:function(a,c,d,e,f,g){var h,i,j,k,l,m,n;if(!b.isKeyReserved(c))return a;for(k in d)for(l=d[k],m=0,n=a.length;n>m;m++)if(h=a[m],Where(h,e)){j=!1;while(k.indexOf(".")>0){if(i=k.split(".")[0],h=h[i],null==h&&!g){j=!0;break}g&&(h=h||{}),k=k.substr(k.indexOf(".")+1)}if(!j){switch(c){case"$inc":(null!=h[k]||g)&&(h[k]+=l);break;case"$set":(null!=h[k]||g)&&(h[k]=l);break;case"$mul":(null!=h[k]||g)&&(h[k]*=l);break;case"$rename":h[l]=h[k],delete h[k];break;case"$unset":delete h[k];break;case"$min":(null!=h[k]||g)&&(h[k]=Math.min(h[k],l));break;case"$max":(null!=h[k]||g)&&(h[k]=Math.max(h[k],l))}if(!f)break}}return a}},a}(),Collection=function(){var a=[].slice,b;return b=function(){function b(a,b){this.engine=b,this.name=""+b.name+"_"+a}return b.prototype.deserialize=function(a){return this.engine.getItem(this.name,function(b,c){return a(Utils.parse(b),c)})},b.prototype.serialize=function(a,b){return this.engine.setItem(this.name,Utils.stringify(a),b)},b.prototype.drop=function(a){var b,c;return c=this,b=function(b,d){return c.engine.removeItem(c.name,function(c){return null!=a&&a(c),null!=c?d(c):b()})},new Promise(b)},b.prototype.insert=function(){var b,c,d,e,f,g,h;return f=arguments[0],d=2<=arguments.length?a.call(arguments,1):[],h=Utils.parseParas(d),c=h[0],b=h[1],g=this,e=function(a,d){return g.deserialize(function(e,h){return null!=h?(null!=b&&b(h),d(h)):(e=Operation.insert(e,f,c),g.serialize(e,function(c){return null!=b&&b(c),null!=c?d(c):a()}))})},new Promise(e)},b.prototype.update=function(){var b,c,d,e,f,g,h;return b=arguments[0],e=2<=arguments.length?a.call(arguments,1):[],h=Utils.parseParas(e),d=h[0],c=h[1],g=this,f=function(a,e){return g.deserialize(function(f,h){return h?(null!=c&&c(h),e(h)):(f=Operation.update(f,b,d),g.serialize(f,function(b){return null!=c&&c(b),null!=b?e(b):a()}))})},new Promise(f)},b.prototype.remove=function(){var b,c,d,e,f,g;return d=1<=arguments.length?a.call(arguments,0):[],g=Utils.parseParas(d),c=g[0],b=g[1],f=this,e=function(a,d){return f.deserialize(function(e,g){return null!=g?(null!=b&&b(g),d(g)):(e=Operation.remove(e,c),f.serialize(e,function(c){return null!=b&&b(c),null!=c?d(c):a()}))})},new Promise(e)},b.prototype.find=function(){var b,c,d,e,f,g;return d=1<=arguments.length?a.call(arguments,0):[],g=Utils.parseParas(d),c=g[0],b=g[1],f=this,e=function(a,d){return f.deserialize(function(e,f){return null!=f?(null!=b&&b([],f),d(f)):(e=Operation.find(e,c),null!=b&&b(e,f),null!=f?d(f):a(e))})},new Promise(e)},b.prototype.findOne=function(){var b,c,d,e,f,g;return d=1<=arguments.length?a.call(arguments,0):[],g=Utils.parseParas(d),c=g[0],b=g[1],c.limit=1,f=this,e=function(a,d){return f.deserialize(function(e,f){return null!=f?(null!=b&&b(void 0,f),d(f)):(e=Operation.find(e,c),null!=b&&b(e[0],f),null!=f?d(f):a(e[0]))})},new Promise(e)},b}()}(),Sha1=function(){var a=0,b="",c=8,d={};d.hex_sha1=function(a){return k(e(j(a),a.length*c))};function e(a,b){a[b>>5]|=128<<24-b%32,a[(b+64>>9<<4)+15]=b;for(var c=Array(80),d=1732584193,e=-271733879,j=-1732584194,k=271733878,l=-1009589776,m=0;m<a.length;m+=16){for(var n=d,o=e,p=j,q=k,r=l,s=0;80>s;s++){c[s]=16>s?a[m+s]:i(c[s-3]^c[s-8]^c[s-14]^c[s-16],1);var t=h(h(i(d,5),f(s,e,j,k)),h(h(l,c[s]),g(s)));l=k,k=j,j=i(e,30),e=d,d=t}d=h(d,n),e=h(e,o),j=h(j,p),k=h(k,q),l=h(l,r)}return Array(d,e,j,k,l)}function f(a,b,c,d){return 20>a?b&c|~b&d:40>a?b^c^d:60>a?b&c|b&d|c&d:b^c^d}function g(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function h(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function i(a,b){return a<<b|a>>>32-b}function j(a){for(var b=Array(),d=(1<<c)-1,e=0;e<a.length*c;e+=c)b[e>>5]|=(a.charCodeAt(e/c)&d)<<24-e%32;return b}function k(b){for(var c=a?"0123456789ABCDEF":"0123456789abcdef",d="",e=0;e<4*b.length;e++)d+=c.charAt(b[e>>2]>>8*(3-e%4)+4&15)+c.charAt(b[e>>2]>>8*(3-e%4)&15);return d}return d}(),Encrypt=function(){var a;return a={},a.encode=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(null==a)return null;for(h=[""],b=Sha1.hex_sha1(b),o=Utils.toUnicode(a),n=Utils.toUnicode(b),m=o.split("\\u").slice(1),k=n.split("\\u").slice(1),f=k.length,e=p=0,q=m.length;q>p;e=++p)l=m[e],g=e%f,j=k[g],d=parseInt(l,16)+parseInt(j,16),d>65536&&(d-=65536),c=("00"+d.toString(16)).slice(-4),h.push(c);return i=h.join("\\u"),Utils.fromUnicode(i)},a.decode=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(null===a)return null;for(h=[""],b=Sha1.hex_sha1(b),o=Utils.toUnicode(a),n=Utils.toUnicode(b),m=o.split("\\u").slice(1),k=n.split("\\u").slice(1),f=k.length,e=p=0,q=m.length;q>p;e=++p)l=m[e],g=e%f,j=k[g],d=parseInt(l,16)-parseInt(j,16),0>d&&(d=65536+d),c=("00"+d.toString(16)).slice(-4),h.push(c);return i=h.join("\\u"),Utils.fromUnicode(i)},a}(),Storage=function(){var a;return a=function(){function a(a){if(this.expire=a.expire,this.encrypt=a.encrypt,this.token=a.name,this.insert_guarantee=a.insert_guarantee,"window"===this.expire){if(!Support.sessionstorage())throw new Error("sessionStorage is not supported!");this.storage=sessionStorage}else if("none"===this.expire){if(!Support.localstorage())throw new Error("localStorage is not supported!");this.storage=localStorage}}return a.prototype.key=function(a,b){var c,d;try{d=this.storage.key(a)}catch(e){c=e,b(-1,c)}b(d)},a.prototype.size=function(a){var b,c;try{c=this.storage.length}catch(d){b=d,a(-1,b)}a(c)},a.prototype.setItem=function(a,b,c){var d,e,f,g;g=this,d=0;try{this.encrypt&&(b=Encrypt.encode(b,this.token)),this.storage.setItem(a,b)}catch(h){if(f=h,!this.insert_guarantee)return void c(f);this.encrypt&&(b=Encrypt.decode(b,this.token)),e=Utils.parse(b);while(d>10)try{e.splice(0,1),b=Utils.stringify(e),g.encrypt&&(b=Encrypt.encode(b,g.token)),g.storage.setItem(a,b),d=11}catch(h){f=h,d+=1}}c(d>10?new Error("exceed maximum times trying setItem into Storage"):void 0)},a.prototype.getItem=function(a,b){var c,d;try{d=this.storage.getItem(a),this.encrypt&&(d=Encrypt.decode(d,this.token))}catch(e){c=e,b(null,c)}b(d)},a.prototype.removeItem=function(a,b){var c;try{this.storage.removeItem(a)}catch(d){c=d,b(c)}b()},a.prototype.usage=function(a){var b,c,d,e,f;try{b="",f=this.storage;for(d in f)e=f[d],b+=e}catch(g){c=g,a(-1,c)}return a(b.length/512)},a}()}(),Evemit=function(){var a=[].slice,b,c;return c=null!=window.addEventListener?!1:!0,b=function(){function b(a){var c,d,e;if(null==a&&(a={}),!Utils.isObject(a))throw new Error("input type error: Input should be object");this.events={},e=b.prototype;for(c in e)d=e[c],a[c]=d;return a}return b.prototype.on=function(a,b){return this.events[a]=this.events[a]||[],this.events[a].push(b)},b.prototype.once=function(a,b){var c;return c=this,this.on(a,function(){return c.off(a),b.apply(this,arguments)})},b.prototype.off=function(a){return delete this.events[a]},b.prototype.emit=function(){var b,c,d,e,f,g,h;if(d=arguments[0],b=2<=arguments.length?a.call(arguments,1):[],null!=this.events[d]){for(g=this.events[d],h=[],e=0,f=g.length;f>e;e++)c=g[e],h.push(c.apply(this,b));return h}},b.prototype.events=function(){var a,b;b=[];for(a in this.events)b.push(a);return b},b.prototype.listeners=function(a){var b,c,d,e,f;for(e=this.events[a],f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(b);return f},b}(),b.bind=function(a,b,d,e){return a[c?"attachEvent":"addEventListener"](""+(c?"on":"")+b,d,e||!1)},b.unbind=function(a,b,d,e){return a[c?"detachEvent":"removeEventListener"](""+(c?"on":"")+b,d,e||!1)},b}(),Proxy=function(){var a;return a=function(){function a(a){var b;b=this,this.expire=a.expire,this.encrypt=a.encrypt,this.name=a.name,this.proxy=a.proxy,this.insert_guarantee=a.insert_guarantee,this.evemit=new Evemit,this.iframe=Utils.createIframe(this.proxy),Evemit.bind(window,"message",function(a){var c;return c=JSON.parse(a.data),-1!==b.proxy.indexOf(a.origin)?null!=c.data?b.evemit.emit(c.eve,c.data,c.err):b.evemit.emit(c.eve,c.err):void 0})}return a.prototype.sendMessage=function(a,b,c){var d,e,f,g;g=this,e=a+"|"+(new Date).getTime(),b.eve=e,b.expire=this.expire,b.encrypt=this.encrypt,b.name=this.name,b.insert_guarantee=this.insert_guarantee,this.evemit.once(e,c),b=JSON.stringify(b),f=this.iframe.contentWindow;try{return f.document,Evemit.bind(this.iframe,"load",function(){return f.postMessage(b,Utils.getOrigin(g.proxy))})}catch(h){return d=h,f.postMessage(b,Utils.getOrigin(this.proxy))}},a.prototype.key=function(a,b){return this.sendMessage("key",{index:a},b)},a.prototype.size=function(a){return this.sendMessage("size",{},a)},a.prototype.setItem=function(a,b,c){return this.sendMessage("setItem",{key:a,val:b},c)},a.prototype.getItem=function(a,b){return this.sendMessage("getItem",{key:a},b)},a.prototype.removeItem=function(a,b){return this.sendMessage("removeItem",{key:a},b)},a.prototype.usage=function(a){return this.sendMessage("usage",{},a)},a}()}(),Engine=function(){var a;return a=function(){function a(a){var b;b=a.proxy,this.name=a.name,null!=b?(b=b.trim(),-1===b.indexOf("http")&&(b="http://"+b),this.proxy=new Proxy(a)):this.storage=new Storage(a)}return a.prototype.key=function(a,b){return(null!=this.proxy?this.proxy:this.storage).key(a,b)},a.prototype.size=function(a){return(null!=this.proxy?this.proxy:this.storage).size(a)},a.prototype.setItem=function(a,b,c){return(null!=this.proxy?this.proxy:this.storage).setItem(a,b,c)},a.prototype.getItem=function(a,b){return(null!=this.proxy?this.proxy:this.storage).getItem(a,b)},a.prototype.removeItem=function(a,b){return(null!=this.proxy?this.proxy:this.storage).removeItem(a,b)},a.prototype.usage=function(a){return(null!=this.proxy?this.proxy:this.storage).usage(a)},a}()}(),Server=function(){var a;return a=function(){function a(a){this.config=a,this.allow=this.config.allow||"*",this.deny=this.config.deny||[],this.storages={}}return a.prototype.postParent=function(a,b){return top.postMessage(JSON.stringify(a),b)},a.prototype.checkOrigin=function(a){var b,c,d,e,f,g,h,i;if(a=Utils.getDomain(a),Utils.isString(this.allow)){if(!this.checkRule(a,this.allow))return!1}else{for(b=!0,h=this.allow,d=0,f=h.length;f>d;d++)if(c=h[d],this.checkRule(a,c)){b=!1;break}if(b)return!1}if(Utils.isString(this.deny)){if(this.checkRule(a,this.deny))return!1}else for(i=this.deny,e=0,g=i.length;g>e;e++)if(c=i[e],this.checkRule(a,c))return!1;return!0},a.prototype.checkRule=function(a,b){var c,d,e,f;if(Utils.isRegex(b))return b.test(a);if(-1===b.indexOf("*"))return a===b;for(d=b.split("*"),e=0,f=d.length;f>e;e++)if(c=d[e],-1===a.indexOf(c))return!1;return!0},a.prototype.init=function(){var a;return a=this,Evemit.bind(window,"message",function(b){var c,d,e;if(c=b.origin,!a.checkOrigin(c))return!1;switch(d=JSON.parse(b.data),null==a.storages[d.name]&&(a.storages[d.name]=new Storage(d)),e=a.storages[d.name],d.eve.split("|")[0]){case"key":return e.key(d.index,function(b,e){return d.data=b,d.err=e,a.postParent(d,c)});case"size":return e.size(function(b,e){return d.data=b,d.err=e,a.postParent(d,c)});case"setItem":return e.setItem(d.key,d.val,function(b){return d.err=b,a.postParent(d,c)});case"getItem":return e.getItem(d.key,function(b,e){return d.data=b,d.err=e,a.postParent(d,c)});case"removeItem":return e.removeItem(d.key,function(b){return d.err=b,a.postParent(d,c)});case"usage":return e.usage(function(b,e){return d.data=b,d.err=e,a.postParent(d,c)})}})},a}()}(),LocalDB=function(){var a,b,c;return b="ldb_",c="0.0.1",a=function(){function a(a,c){if(null==c&&(c={}),null==a)throw new Error("dbName should be specified.");this.name=b+a,this.expire=null!=c.expire?c.expire:"window",this.encrypt=null!=c.encrypt?c.encrypt:!0,this.proxy=null!=c.proxy?c.proxy:null,this.insert_guarantee=c.guarantee?c.guarantee:!1,this.engine=new Engine({expire:this.expire,encrypt:this.encrypt,name:this.name,proxy:this.proxy,insert_guarantee:this.insert_guarantee})}return a.prototype.options=function(){return{name:this.name.substr(b.length),expire:this.expire,encrypt:this.encrypt,proxy:this.proxy}},a.prototype.collection=function(a){if(null==a)throw new Error("collectionName should be specified.");return new Collection(a,this.engine)},a}(),a.getSupport=function(){return Support},a.getVersion=function(){return c},a.getTimestamp=function(a){return Utils.getTimestamp(a)},a.getTime=function(a){return Utils.getTime(a)},a.init=function(a){return new Server(a).init()},a}();return"function"==typeof define&&define.amd&&define("localdb",[],function(){return LocalDB}),noGlobal||(window.LocalDB=LocalDB),LocalDB});
//# sourceMappingURL=localdb.min.map