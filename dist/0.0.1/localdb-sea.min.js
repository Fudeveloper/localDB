/*! localDB - v0.0.1 - 2014-11-10
* https://github.com/wh1100717/localDB
* Copyright (c) 2014 Eric Wang; Licensed MIT */

define(function(require,exports,module){!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("localdb requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(window,noGlobal){"use strict";for(var maxBits=[],i=0;64>i;i++)maxBits[i]=Math.pow(2,i);function BinaryParser(a,b){return this instanceof BinaryParser?(this.bigEndian=a,void(this.allowExceptions=b)):new BinaryParser(a,b)}BinaryParser.warn=function a(b){if(this.allowExceptions)throw new Error(b);return 1},BinaryParser.decodeInt=function b(a,c,d,e){var f=new this.Buffer(this.bigEndian||e,a),g=f.readBits(0,c),h=maxBits[c];return d&&g>=h/2?g-h:g},BinaryParser.encodeInt=function c(a,b,d,e){var f=maxBits[b];(a>=f||-(f/2)>a)&&(this.warn("encodeInt::overflow"),a=0),0>a&&(a+=f);for(var g=[];a;g[g.length]=String.fromCharCode(a%256),a=Math.floor(a/256));for(b=-(-b>>3)-g.length;b--;g[g.length]="\x00");return(this.bigEndian||e?g.reverse():g).join("")},BinaryParser.fromByte=function(a){return this.encodeInt(a,8,!1)},BinaryParser.fromShort=function(a){return this.encodeInt(a,16,!0)};function BinaryParserBuffer(a,b){this.bigEndian=a||0,this.buffer=[],this.setBuffer(b)}BinaryParserBuffer.prototype.setBuffer=function d(a){var b,c,d;if(a){for(c=b=a.length,d=this.buffer=new Array(b);c;d[b-c]=a.charCodeAt(--c));this.bigEndian&&d.reverse()}},BinaryParserBuffer.prototype.hasNeededBits=function e(a){return this.buffer.length>=-(-a>>3)},BinaryParserBuffer.prototype.checkBuffer=function f(a){if(!this.hasNeededBits(a))throw new Error("checkBuffer::missing bytes")},BinaryParserBuffer.prototype.readBits=function g(a,b){function c(a,b){for(;b--;a=1073741824==(1073741824&(a%=2147483648))?2*a:2*(a-1073741824)+2147483647+1);return a}if(0>a||0>=b)return 0;this.checkBuffer(a+b);for(var d,e=a%8,f=this.buffer.length-(a>>3)-1,g=this.buffer.length+(-(a+b)>>3),h=f-g,i=(this.buffer[f]>>e&(1<<(h?8-e:b))-1)+(h&&(d=(a+b)%8)?(this.buffer[g++]&(1<<d)-1)<<(h--<<3)-e:0);h;i+=c(this.buffer[g++],(h--<<3)-e));return i},BinaryParser.Buffer=BinaryParserBuffer,self.BinaryParser=BinaryParser;var ObjectID,hexTable,i;hexTable=function(){var a,b;for(b=[],i=a=0;256>a;i=++a)b.push((15>=i?"0":"")+i.toString(16));return b}(),ObjectID=function(){function a(a,b){if(this._bsontype="ObjectID",this.MACHINE_ID=parseInt(16777215*Math.random(),10),null!=a&&12!==a.length&&24!==a.length)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(null==a)this.id=this.generate();else{if(null==a||12!==a.length){if(/^[0-9a-fA-F]{24}$/.test(a))return this.createFromHexString(a);throw new Error("Value passed in is not a valid 24 character hex string")}this.id=a}}return a.prototype.generate=function(){var a,b,c,d,e;return e=parseInt(Date.now()/1e3,10),d=BinaryParser.encodeInt(e,32,!0,!0),b=BinaryParser.encodeInt(this.MACHINE_ID,24,!1),c=BinaryParser.fromShort("undefined"==typeof process?Math.floor(1e5*Math.random()):process.pid),a=BinaryParser.encodeInt(this.get_inc(),24,!1,!0),d+b+c+a},a.prototype.toHexString=function(){var a,b,c;for(a="",i=b=0,c=this.id.length;c>=0?c>b:b>c;i=c>=0?++b:--b)a+=hexTable[this.id.charCodeAt(i)];return a},a.prototype.toString=function(){return this.toHexString()},a.prototype.inspect=function(){return this.toHexString()},a.prototype.getTime=function(){return 1e3*Math.floor(BinaryParser.decodeInt(this.id.substring(0,4),32,!0,!0))},a.prototype.getTimestamp=function(){var a;return a=new Date,a.setTime(this.getTime()),a},a.prototype.get_inc=function(){return a.index=(a.index+1)%16777215},a.prototype.createFromHexString=function(b){var c,d;for(c="",i=d=0;24>d;i=++d)i%2===0&&(c+=BinaryParser.fromByte(parseInt(b.substr(i,2),16)));return new a(c,b)},a}(),ObjectID.index=parseInt(16777215*Math.random(),10),self.ObjectID=ObjectID;var Utils,eq,toString,_isType;Utils={},toString=Object.prototype.toString,eq=function(a,b,c,d){var e,f,g,h,i,j,k,l,m;if(a===b)return 0!==a||1/a===1/b;if(null===a&&void 0===b)return!1;if(void 0===a&&null===b)return!1;if(h=toString.call(a),h!==toString.call(b))return!1;switch(h){case"[object RegExp]":return""+a==""+b;case"[object String]":return""+a==""+b;case"[object Number]":return+a!==+a?+b!==+b:0===+a?1/+a===1/b:+a===+b;case"[object Date]":return+a===+b;case"[object Boolean]":return+a===+b}if(f="[object Array]"===h,!f){if("object"!=typeof a||"object"!=typeof b)return!1;if(e=a.constructor,g=b.constructor,e!==g&&!(Utils.isFunction(e)&&e instanceof e&&Utils.isFunction(g)&&g instanceof g)&&"constructor"in a&&"constructor"in b)return!1}k=c.length;while(k--)if(c[k]===a)return d[k]===b;if(c.push(a),d.push(b),f){if(m=a.length,l=m===b.length)while(m--)if(!(l=eq(a[m],b[m],c,d)))break}else if(j=Utils.keys(a),m=j.length,l=Utils.keys(b).length===m)while(m--)if(i=j[m],!(l=Utils.has(b,i)&&eq(a[i],b[i],c,d)))break;return c.pop(),d.pop(),l},_isType=function(a){return function(b){return toString.call(b).toLowerCase()===("[object "+a+"]").toLowerCase()}},Utils.isType=function(a,b){return _isType(b)(a)},Utils.isObject=_isType("object"),Utils.isString=_isType("string"),Utils.isNumber=_isType("number"),Utils.isArray=_isType("array"),Utils.isFunction=_isType("function"),Utils.isRegex=_isType("regexp"),Utils.keys=function(a){return Utils.isObject(a)?Object.keys?Object.keys(a):void 0:[]},Utils.has=function(a,b){return null!==a&&void 0!==a&&Object.prototype.hasOwnProperty.call(a,b)},Utils.isEqual=function(a,b){return eq(a,b,[],[])},Utils.createObjectId=function(){return(new ObjectID).inspect()},Utils.stringify=function(a){return null!=a&&Utils.isArray(a)?JSON.stringify(a,function(a,b){return Utils.isRegex(b)||Utils.isFunction(b)?b.toString():b}):"[]"},Utils.parse=function(str){return null!=str&&Utils.isString(str)?JSON.parse(str,function(key,value){var v;try{v=eval(value)}catch(_error){}if(null!=v&&Utils.isRegex(v))return v;try{v=eval("("+value+")")}catch(_error){}return null!=v&&Utils.isFunction(v)?v:value}):[]},Utils.parseParas=function(a){var b,c;return c={},b=null,1===a.length?Utils.isObject(a[0])?c=a[0]:Utils.isFunction(a[0])&&(b=a[0]):2===a.length&&(Utils.isObject(a[0])&&(c=a[0]),Utils.isFunction(a[1])&&(b=a[1])),[c,b]},Utils.getTimestamp=function(a){return new ObjectID(a).getTimestamp()},Utils.getTime=function(a){return new ObjectID(a).getTime()},Utils.toUnicode=function(a){var b,c,d,e,f;e=[""],c=1,d=a.length;while(d>=c)b=a.charCodeAt(c-1),f="00"+b.toString(16),f=f.slice(-4),e.push(f),c+=1;return e.join("\\u")},Utils.fromUnicode=function(a){var b;return b=a.replace(/\\/g,"%"),unescape(b)},self.Utils=Utils;var __indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},Where,arrayCheck,dotCheck,isKeyReserved,keywordCheck,numberCheck,objectCheck,regexCheck,reservedKeys,stringCheck,valueCheck;reservedKeys=["$gt","$gte","$lt","$lte","$ne","$in","$nin","$and","$nor","$or","$not","$exists","$type","$mod","$regex","$all","$elemMatch","$size"],isKeyReserved=function(a){return __indexOf.call(reservedKeys,a)>=0},Where=function(a,b){var c,d;for(d in b){if(c=b[d],null==a){if("$exists"===d&&c===!1)continue;return!1}if(-1!==d.indexOf(".")){if(dotCheck(a,d,c))continue;return!1}if(!valueCheck(a,d,c))return!1;if(!keywordCheck(a,d,c))return!1}return!0},dotCheck=function(a,b,c){var d;return d=b.split(".")[0],Where(a[/\d/.test(d)?Number(d):d],new function(){this[b.substr(b.indexOf(".")+1)]=c})},valueCheck=function(a,b,c){var d;return isKeyReserved(b)?!0:(d=a[b],Utils.isNumber(c)&&!numberCheck(d,c)?!1:Utils.isString(c)&&!stringCheck(d,c)?!1:Utils.isRegex(c)&&!regexCheck(d,c)?!1:Utils.isArray(c)&&!arrayCheck(d,c)?!1:Utils.isObject(c)&&!objectCheck(d,c)?!1:!0)},keywordCheck=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n;switch(b){case"$gt":if(c>=a)return!1;break;case"$gte":if(c>a)return!1;break;case"$lt":if(a>=c)return!1;break;case"$lte":if(a>c)return!1;break;case"$ne":if(a===c)return!1;break;case"$in":if(Utils.isArray(a)){for(f=!0,g=0,k=a.length;k>g;g++)e=a[g],f&&function(){var a,b,d;for(b=0,d=c.length;d>b;b++)if(a=c[b],Utils.isRegex(a)&&a.test(e)||Utils.isEqual(a,e))return!0;return!1}()&&(f=!1);if(f)return!1}else if(!function(){var b,d,e;for(d=0,e=c.length;e>d;d++)if(b=c[d],Utils.isRegex(b)&&b.test(a)||Utils.isEqual(b,a))return!0;return!1}())return!1;break;case"$nin":if(__indexOf.call(c,a)>=0)return!1;break;case"$exists":if(c!==(null!=a))return!1;break;case"$type":if(!Utils.isType(a,c))return!1;break;case"$mod":if(a%c[0]!==c[1])return!1;break;case"$regex":if(!new RegExp(c).test(a))return!1;break;case"$and":for(h=0,l=c.length;l>h;h++)if(d=c[h],!Where(a,d))return!1;break;case"$nor":for(i=0,m=c.length;m>i;i++)if(d=c[i],Where(a,d))return!1;break;case"$or":if(!function(){var b,e;for(b=0,e=c.length;e>b;b++)if(d=c[b],Where(a,d))return!0;return!1}())return!1;break;case"$not":if(Where(a,c))return!1;break;case"$all":if(!Utils.isArray(a))return!1;for(j=0,n=c.length;n>j;j++)if(d=c[j],!function(){var c,f;for(f=0,c=a.length;c>f;f++)if(e=a[f],Utils.isArray(d)?keywordCheck(e,b,d):e===d)return!0}())return!1;break;case"$elemMatch":if(!Utils.isArray(a))return!1;if(!function(){var b,d;for(d=0,b=a.length;b>d;d++)if(e=a[d],Where(e,c))return!0}())return!1;break;case"$size":if(!Utils.isArray(a))return!1;if(a.length!==c)return!1}return!0},numberCheck=function(a,b){return Utils.isNumber(a)&&b===a?!0:Utils.isArray(a)&&__indexOf.call(a,b)>=0?!0:!1},stringCheck=function(a,b){return Utils.isString(a)&&b===a?!0:Utils.isArray(a)&&__indexOf.call(a,b)>=0?!0:!1},regexCheck=function(a,b){var c,d,e;if(Utils.isArray(a)){for(d=0,e=a.length;e>d;d++)if(c=a[d],Utils.isRegex(c)){if(Utils.isEqual(c,b))return!0}else if(b.test(c))return!0}else if(Utils.isRegex(a)){if(Utils.isEqual(a,b))return!0}else if(b.test(a))return!0;return!1},arrayCheck=function(a,b){return Utils.isEqual(a,b)},objectCheck=function(a,b){var c,d,e;d=!0;for(e in b)if(c=b[e],isKeyReserved(e)&&(d=!1,!Where(a,new function(){this[e]=c})))return!1;return d?Utils.isEqual(a,b):!0},self.Where=Where;var Projection,generateItem;Projection={},Projection.generate=function(a,b){var c,d,e,f,g;if("{}"===JSON.stringify(b))return a;for(e=[],f=0,g=a.length;g>f;f++)c=a[f],d=generateItem(c,b),Utils.isEqual(d,{})||e.push(d);return e},generateItem=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;i={},f=!0;for(g in b)if(l=b[g],"_id"!==g||-1!==l)if(-1!==g.indexOf(".$")){if(g=g.split(".")[0],!Utils.isArray(a[g])||0===a[g].length)continue;i[g]=[a[g][0]]}else{if(0===g.indexOf("$elemMatch")){if(!Utils.isArray(a)||0===a.length)return[];for(h=[],m=0,n=a.length;n>m;m++){e=a[m],c=!0;for(j in l)k=l[j],Utils.isObject(k)||e[j]!==k&&(c=!1);if(c){h.push(e);break}}return Utils.isEqual(h,[])?[]:h}Utils.isObject(l)?(d=generateItem(a[g],l),Utils.isEqual(d,[])||(i[g]=d)):1===l&&(i[g]=a[g])}else f=!1;return f&&!Utils.isEqual(i,{})&&(i._id=a._id),i},self.Projection=Projection;var Operation,Update;Operation={},Operation.insert=function(a,b,c){var d,e,f;if(Utils.isArray(b))for(e=0,f=b.length;f>e;e++)d=b[e],Utils.isObject(d)&&(null==d._id&&(d._id=Utils.createObjectId()),a.push(d));else Utils.isObject(b)&&(null==b._id&&(b._id=Utils.createObjectId()),a.push(b));return a},Operation.update=function(a,b,c){var d,e,f,g,h;h=c.where||{},e=null!=c.multi?c.multi:!0,f=null!=c.upsert?c.upsert:!1;for(d in b)g=b[d],a=Update.generate(a,d,g,h,e,f);return a},Operation.remove=function(a,b){var c,d,e,f,g,h,i;for(g=b.where||{},e=null!=b.multi?b.multi:!0,f=[],d=!1,h=0,i=a.length;i>h;h++)c=a[h],d?f.push(c):Where(c,g)?e||(d=!0):f.push(c);return f},Operation.find=function(a,b){var c,d,e,f,g,h,i;for(g=b.where||{},e=b.projection||{},d=b.limit||-1,f=[],h=0,i=a.length;i>h;h++)if(c=a[h],Where(c,g)){if(0===d)break;d-=1,f.push(c)}return Projection.generate(f,e)},Update={isKeyReserved:function(a){return"$inc"===a||"$set"===a||"$mul"===a||"$rename"===a||"$unset"===a||"$max"===a||"$min"===a},generate:function(a,b,c,d,e,f){var g,h,i,j,k,l,m;if(!Update.isKeyReserved(b))return a;for(j in c)for(k=c[j],l=0,m=a.length;m>l;l++)if(g=a[l],Where(g,d)){i=!1;while(j.indexOf(".")>0){if(h=j.split(".")[0],g=g[h],null==g&&!f){i=!0;break}f&&(g=g||{}),j=j.substr(j.indexOf(".")+1)}if(!i){switch(b){case"$inc":(null!=g[j]||f)&&(g[j]+=k);break;case"$set":(null!=g[j]||f)&&(g[j]=k);break;case"$mul":(null!=g[j]||f)&&(g[j]*=k);break;case"$rename":g[k]=g[j],delete g[j];break;case"$unset":delete g[j];break;case"$min":(null!=g[j]||f)&&(g[j]=Math.min(g[j],k));break;case"$max":(null!=g[j]||f)&&(g[j]=Math.max(g[j],k))}if(!e)break}}return a}},self.Operation=Operation;var head={task:void 0,next:null},tail=head,flushing=!1,requestFlush=void 0,isNodeJS=!1;function flush(){while(head.next){head=head.next;var a=head.task;head.task=void 0;var b=head.domain;b&&(head.domain=void 0,b.enter());try{a()}catch(c){if(isNodeJS)throw b&&b.exit(),setTimeout(flush,0),b&&b.enter(),c;setTimeout(function(){throw c},0)}b&&b.exit()}flushing=!1}if("undefined"!=typeof process&&process.nextTick)isNodeJS=!0,requestFlush=function(){process.nextTick(flush)};else if("function"==typeof setImmediate)requestFlush="undefined"!=typeof window?setImmediate.bind(window,flush):function(){setImmediate(flush)};else if("undefined"!=typeof MessageChannel){var channel=new MessageChannel;channel.port1.onmessage=flush,requestFlush=function(){channel.port2.postMessage(0)}}else requestFlush=function(){setTimeout(flush,0)};function asap(a){tail=tail.next={task:a,domain:isNodeJS&&process.domain,next:null},flushing||(flushing=!0,requestFlush())}function Promise(a){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");var b=null,c=null,d=[],e=this;this.then=function(a,b){return new e.constructor(function(c,d){f(new Handler(a,b,c,d))})};function f(a){return null===b?void d.push(a):void asap(function(){var d=b?a.onFulfilled:a.onRejected;if(null===d)return void(b?a.resolve:a.reject)(c);var e;try{e=d(c)}catch(f){return void a.reject(f)}a.resolve(e)})}function g(a){try{if(a===e)throw new TypeError("A promise cannot be resolved with itself.");if(a&&("object"==typeof a||"function"==typeof a)){var d=a.then;if("function"==typeof d)return void doResolve(d.bind(a),g,h)}b=!0,c=a,i()}catch(f){h(f)}}function h(a){b=!1,c=a,i()}function i(){for(var a=0,b=d.length;b>a;a++)f(d[a]);d=null}doResolve(a,g,h)}function Handler(a,b,c,d){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.resolve=c,this.reject=d}function doResolve(a,b,c){var d=!1;try{a(function(a){d||(d=!0,b(a))},function(a){d||(d=!0,c(a))})}catch(e){if(d)return;d=!0,c(e)}}Promise.prototype.done=function(a,b){var c=arguments.length?this.then.apply(this,arguments):this;c.then(null,function(a){asap(function(){throw a})})};function ValuePromise(a){this.then=function(b){return"function"!=typeof b?this:new Promise(function(c,d){asap(function(){try{c(b(a))}catch(e){d(e)}})})}}ValuePromise.prototype=Promise.prototype;var TRUE=new ValuePromise(!0),FALSE=new ValuePromise(!1),NULL=new ValuePromise(null),UNDEFINED=new ValuePromise(void 0),ZERO=new ValuePromise(0),EMPTYSTRING=new ValuePromise("");Promise.resolve=function(a){if(a instanceof Promise)return a;if(null===a)return NULL;if(void 0===a)return UNDEFINED;if(a===!0)return TRUE;if(a===!1)return FALSE;if(0===a)return ZERO;if(""===a)return EMPTYSTRING;if("object"==typeof a||"function"==typeof a)try{var b=a.then;if("function"==typeof b)return new Promise(b.bind(a))}catch(c){return new Promise(function(a,b){b(c)})}return new ValuePromise(a)},Promise.all=function(a){var b=Array.prototype.slice.call(a);return new Promise(function(a,c){if(0===b.length)return a([]);var d=b.length;function e(f,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(a){e(f,a)},c)}b[f]=g,0===--d&&a(b)}catch(i){c(i)}}for(var f=0;f<b.length;f++)e(f,b[f])})},Promise.reject=function(a){return new Promise(function(b,c){c(a)})},Promise.race=function(a){return new Promise(function(b,c){a.forEach(function(a){Promise.resolve(a).then(b,c)})})},Promise.prototype["catch"]=function(a){return this.then(null,a)},Promise.denodeify=function(a,b){return b=b||1/0,function(){var c=this,d=Array.prototype.slice.call(arguments);return new Promise(function(e,f){while(d.length&&d.length>b)d.pop();d.push(function(a,b){a?f(a):e(b)}),a.apply(c,d)})}},Promise.nodeify=function(a){return function(){var b=Array.prototype.slice.call(arguments),c="function"==typeof b[b.length-1]?b.pop():null,d=this;try{return a.apply(this,arguments).nodeify(c,d)}catch(e){if(null===c||"undefined"==typeof c)return new Promise(function(a,b){b(e)});asap(function(){c.call(d,e)})}}},Promise.prototype.nodeify=function(a,b){return"function"!=typeof a?this:void this.then(function(c){asap(function(){a.call(b,null,c)})},function(c){asap(function(){a.call(b,c)})})},self.Promise=Promise;var __slice=[].slice,Collection;Collection=function(){function a(a,b){this.engine=b,this.name=""+b.name+"_"+a}return a.prototype.deserialize=function(a){return this.engine.getItem(this.name,function(b,c){return a(Utils.parse(b),c)})},a.prototype.serialize=function(a,b){return this.engine.setItem(this.name,Utils.stringify(a),b)},a.prototype.drop=function(a){var b,c;return c=this,b=function(b,d){return c.engine.removeItem(c.name,function(c){return null!=a&&a(c),null!=c?d(c):b()})},new Promise(b)},a.prototype.insert=function(){var a,b,c,d,e,f,g;return e=arguments[0],c=2<=arguments.length?__slice.call(arguments,1):[],g=Utils.parseParas(c),b=g[0],a=g[1],f=this,d=function(c,d){return f.deserialize(function(g,h){return null!=h?(null!=a&&a(h),d(h)):(g=Operation.insert(g,e,b),f.serialize(g,function(b){return null!=a&&a(b),null!=b?d(b):c()}))})},new Promise(d)},a.prototype.update=function(){var a,b,c,d,e,f,g;return a=arguments[0],d=2<=arguments.length?__slice.call(arguments,1):[],g=Utils.parseParas(d),c=g[0],b=g[1],f=this,e=function(d,e){return f.deserialize(function(g,h){return h?(null!=b&&b(h),e(h)):(g=Operation.update(g,a,c),f.serialize(g,function(a){return null!=b&&b(a),null!=a?e(a):d()}))})},new Promise(e)},a.prototype.remove=function(){var a,b,c,d,e,f;return c=1<=arguments.length?__slice.call(arguments,0):[],f=Utils.parseParas(c),b=f[0],a=f[1],e=this,d=function(c,d){return e.deserialize(function(f,g){return null!=g?(null!=a&&a(g),d(g)):(f=Operation.remove(f,b),e.serialize(f,function(b){return null!=a&&a(b),null!=b?d(b):c()}))})},new Promise(d)},a.prototype.find=function(){var a,b,c,d,e,f;return c=1<=arguments.length?__slice.call(arguments,0):[],f=Utils.parseParas(c),b=f[0],a=f[1],e=this,d=function(c,d){return e.deserialize(function(e,f){return null!=f?(null!=a&&a([],f),d(f)):(e=Operation.find(e,b),null!=a&&a(e,f),null!=f?d(f):c(e))})},new Promise(d)},a.prototype.findOne=function(){var a,b,c,d,e,f;return c=1<=arguments.length?__slice.call(arguments,0):[],f=Utils.parseParas(c),b=f[0],a=f[1],b.limit=1,e=this,d=function(c,d){return e.deserialize(function(e,f){return null!=f?(null!=a&&a(void 0,f),d(f)):(e=Operation.find(e,b),null!=a&&a(e[0],f),null!=f?d(f):c(e[0]))})},new Promise(d)},a}(),self.Collection=Collection;var Support,mod;mod="lST$*@?",Support={},Support.localstorage=function(){var a;try{return localStorage.setItem(mod,mod),localStorage.removeItem(mod),!0}catch(b){return a=b,!1}},Support.sessionstorage=function(){var a;try{return sessionStorage.setItem(mod,mod),sessionStorage.removeItem(mod),!0}catch(b){return a=b,!1}},Support.postmessage=function(){return"undefined"!=typeof postMessage&&null!==postMessage},Support.websqldatabase=function(){return"undefined"!=typeof openDatabase&&null!==openDatabase},Support.indexedDB=function(){return"undefined"!=typeof indexedDB&&null!==indexedDB||"undefined"!=typeof webkitIndexedDB&&null!==webkitIndexedDB||"undefined"!=typeof mozIndexedDB&&null!==mozIndexedDB||"undefined"!=typeof OIndexedDB&&null!==OIndexedDB||"undefined"!=typeof msIndexedDB&&null!==msIndexedDB},Support.applicationcache=function(){return"undefined"!=typeof applicationCache&&null!==applicationCache},Support.userdata=function(){return null!=document.documentElement.addBehavior},self.Support=Support;var UserData;UserData=function(){function a(){var a,b;try{b=new ActiveXObject("htmlfile"),b.open(),b.write('<script>document.w=window</script><iframe src="/favicon.ico"></iframe>'),b.close(),this.storageOwner=b.w.frames[0].document,this.storage=this.storageOwner.createElement("div")}catch(c){a=c,this.storage=document.createElement("div"),this.storageOwner=document.body}}return a.prototype.localStorageName="localStorage",a.prototype.forbiddenCharsRegex=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g"),a.prototype.ieKeyFix=function(a){return a.replace(/^d/,"___$&").replace(this.forbiddenCharsRegex,"___")},a.prototype.setItem=function(a,b){return a=this.ieKeyFix(a),this.storageOwner.appendChild(this.storage),this.storage.addBehavior("#default#userData"),this.storage.load(this.localStorageName),this.storage.setAttribute(a,b),this.storage.save(this.localStorageName),!0},a.prototype.getItem=function(a){return a=this.ieKeyFix(a),this.storageOwner.appendChild(this.storage),this.storage.addBehavior("#default#userData"),this.storage.load(this.localStorageName),this.storage.getAttribute(a)},a.prototype.removeItem=function(a){return a=this.ieKeyFix(a),this.storageOwner.appendChild(this.storage),this.storage.addBehavior("#default#userData"),this.storage.load(this.localStorageName),this.storage.removeAttribute(a),this.storage.save(this.localStorageName)},a.prototype.size=function(){return this.storage.XMLDocument.documentElement.attributes.length},a.prototype.key=function(a){return this.storage.XMLDocument.documentElement.attributes[a]},a}(),self.UserData=UserData;var hexcase=0,b64pad="",chrsz=8,Sha1={};Sha1.hex_sha1=function(a){return binb2hex(core_sha1(str2binb(a),a.length*chrsz))};function core_sha1(a,b){a[b>>5]|=128<<24-b%32,a[(b+64>>9<<4)+15]=b;for(var c=Array(80),d=1732584193,e=-271733879,f=-1732584194,g=271733878,h=-1009589776,i=0;i<a.length;i+=16){for(var j=d,k=e,l=f,m=g,n=h,o=0;80>o;o++){c[o]=16>o?a[i+o]:rol(c[o-3]^c[o-8]^c[o-14]^c[o-16],1);var p=safe_add(safe_add(rol(d,5),sha1_ft(o,e,f,g)),safe_add(safe_add(h,c[o]),sha1_kt(o)));h=g,g=f,f=rol(e,30),e=d,d=p}d=safe_add(d,j),e=safe_add(e,k),f=safe_add(f,l),g=safe_add(g,m),h=safe_add(h,n)}return Array(d,e,f,g,h)}function sha1_ft(a,b,c,d){return 20>a?b&c|~b&d:40>a?b^c^d:60>a?b&c|b&d|c&d:b^c^d}function sha1_kt(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function safe_add(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function rol(a,b){return a<<b|a>>>32-b}function str2binb(a){for(var b=Array(),c=(1<<chrsz)-1,d=0;d<a.length*chrsz;d+=chrsz)b[d>>5]|=(a.charCodeAt(d/chrsz)&c)<<24-d%32;return b}function binb2hex(a){for(var b=hexcase?"0123456789ABCDEF":"0123456789abcdef",c="",d=0;d<4*a.length;d++)c+=b.charAt(a[d>>2]>>8*(3-d%4)+4&15)+b.charAt(a[d>>2]>>8*(3-d%4)&15);return c}self.Sha1=Sha1;var Encrypt;Encrypt={},Encrypt.encode=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(null===a)return null;for(h=[""],b=Sha1.hex_sha1(b),o=Utils.toUnicode(a),n=Utils.toUnicode(b),m=o.split("\\u").slice(1),k=n.split("\\u").slice(1),f=k.length,e=p=0,q=m.length;q>p;e=++p)l=m[e],g=e%f,j=k[g],d=parseInt(l,16)+parseInt(j,16),d>65536&&(d-=65536),c=("00"+d.toString(16)).slice(-4),h.push(c);return i=h.join("\\u"),Utils.fromUnicode(i)},Encrypt.decode=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(null===a)return null;for(h=[""],b=Sha1.hex_sha1(b),o=Utils.toUnicode(a),n=Utils.toUnicode(b),m=o.split("\\u").slice(1),k=n.split("\\u").slice(1),f=k.length,e=p=0,q=m.length;q>p;e=++p)l=m[e],g=e%f,j=k[g],d=parseInt(l,16)-parseInt(j,16),0>d&&(d=65536+d),c=("00"+d.toString(16)).slice(-4),h.push(c);return i=h.join("\\u"),Utils.fromUnicode(i)},self.Encrypt=Encrypt;var Storage;Storage=function(){function a(a,b,c){if(this.session=a,this.encrypt=b,this.token=c,this.session){if(!Support.sessionstorage())throw new Error("sessionStorage is not supported!")}else if(!Support.localstorage()){if(!Support.userdata())throw new Error("no browser storage engine is supported in your browser!");this.userdata=new UserData}}return a.prototype.key=function(a,b){var c,d;try{d=(this.session?sessionStorage:null!=this.userdata?this.userdata:localStorage).key(a)}catch(e){c=e,b(-1,c)}b(d)},a.prototype.size=function(a){var b,c;try{c=this.session?sessionStorage.length:Support.localstorage()?localStorage.length:this.userdata.size()}catch(d){b=d,a(-1,b)}a(c)},a.prototype.setItem=function(a,b,c){var d,e,f,g;g=this.session?sessionStorage:null!=this.userdata?this.userdata:localStorage;try{this.encrypt&&(b=Encrypt.encode(b,this.token)),g.setItem(a,b)}catch(h){e=h,f=!0,d=Utils.parse(b);while(f)try{d.splice(0,1),g.setItem(a,Utils.stringify(d)),f=!1}catch(h){}}c()},a.prototype.getItem=function(a,b){var c,d;try{d=(this.session?sessionStorage:null!=this.userdata?this.userdata:localStorage).getItem(a),this.encrypt&&(d=Encrypt.decode(d,this.token))}catch(e){c=e,b(null,c)}b(d)},a.prototype.removeItem=function(a,b){var c;try{(this.session?sessionStorage:null!=this.userdata?this.userdata:localStorage).removeItem(a)}catch(d){c=d,b(c)}b()},a.prototype.usage=function(a){var b,c,d,e;try{if(b="",1===this.tyep)for(d in sessionStorage)e=sessionStorage[d],b+=e;else if(Support.localstorage())for(d in localStorage)e=localStorage[d],b+=e;else console.log("todo")}catch(f){c=f,a(-1,c)}return a(b.length/512)},a}(),self.Storage=Storage;var Proxy;Proxy={},self.Proxy=Proxy;var Engine;Engine=function(){function a(a,b,c,d){this.session=a,this.encrypt=b,this.name=c,this.proxy=d,null!=this.proxy?this.proxy=new Proxy(this.session,this.encrypt,this.name,this.proxy):this.storage=new Storage(this.session,this.encrypt,this.name)}return a.prototype.key=function(a,b){return(null!=this.proxy?this.proxy:this.storage).key(a,b)},a.prototype.size=function(a){return(null!=this.proxy?this.proxy:this.storage).size(a)},a.prototype.setItem=function(a,b,c){return(null!=this.proxy?this.proxy:this.storage).setItem(a,b,c)},a.prototype.getItem=function(a,b){return(null!=this.proxy?this.proxy:this.storage).getItem(a,b)},a.prototype.removeItem=function(a,b){return(null!=this.proxy?this.proxy:this.storage).removeItem(a,b)},a.prototype.usage=function(a){return(null!=this.proxy?this.proxy:this.storage).usage(a)},a}(),self.Engine=Engine;var LocalDB,dbPrefix;return dbPrefix="ldb_",LocalDB=function(){function a(a,b){if(null==b&&(b={}),null==a)throw new Error("dbName should be specified.");this.name=dbPrefix+a,this.session=null!=b.session?b.session:!0,this.encrypt=null!=b.encrypt?b.encrypt:!0,this.proxy=null!=b.proxy?b.proxy:null,this.engine=new Engine(this.session,this.encrypt,this.name,this.proxy)}return a.prototype.options=function(){return{name:this.name.substr(dbPrefix.length),session:this.session,encrypt:this.encrypt,proxy:this.proxy}},a.prototype.collection=function(a){if(null==a)throw new Error("collectionName should be specified.");return new Collection(a,this.engine)},a}(),LocalDB.support=Support,LocalDB.version="0.0.1",LocalDB.getTimestamp=function(a){return Utils.getTimestamp(a)},LocalDB.getTime=function(a){return Utils.getTime(a)},self.LocalDB=LocalDB,"function"==typeof define&&define.amd&&define("localdb",[],function(){return LocalDB}),noGlobal||(window.LocalDB=LocalDB),LocalDB})});
//# sourceMappingURL=localdb-sea.min.map